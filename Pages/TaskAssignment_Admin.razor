@page "/task_assignment_admin/{email}/{userName}/{userClass}"

@using Syncfusion.Blazor
@using Syncfusion.Blazor.Inputs
@using Syncfusion.Blazor.Buttons
@using Syncfusion.Blazor.Popups
@using Syncfusion.Blazor.Spinner
@using Syncfusion.Blazor.DropDowns
@using Syncfusion.Blazor.Grids
@using Syncfusion.Blazor.Navigations
@using Syncfusion.Blazor.Calendars
@using Newtonsoft.Json;
@using Newtonsoft.Json.Linq;
@using System.Diagnostics;
@using System.Text.RegularExpressions;

@inject SfDialogService DialogService
@inject NavigationManager NavManager
@inject State State

@namespace NissayaEditor_Web.Data
@using Tipitaka_DBTables
@using Tipitaka_DB

@* *************************************************************************** *@
@* ********************* Entry Point to TaskAssignments ********************** *@
@* *************************************************************************** *@
@code {
    [Parameter]
    public string email { get; set; } = "";
    [Parameter]
    public string userName { get; set; } = "";
    [Parameter]
    public string userClass { get; set; } = "";

    public class DataItem
    {
        public string ID { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
    public class AssignedTaskData
    {
        public DateTime dateTime;
        public UserTaskProgressInfo? userTaskProgressInfo;

        public AssignedTaskData()
        {
            dateTime = DateTime.MaxValue;
        }
    }
    //***********************************************************************
    //*** DisplaySpinner(bool) - turns on Sfspinner on/off
    //***********************************************************************
    private async Task DisplaySpinner(bool isVisible)
    {
        VisibleSpinner = isVisible; // Set to true to make the spinner visible
        StateHasChanged(); // Update the UI
        // Introduce a delay
        await Task.Delay(100);
    }
    /************************************************************************************/
    //***********************************************************************
    //***************************** Initialize ******************************
    //***********************************************************************
    protected override async Task OnInitializedAsync()
    //List<string> tasks = new List<string> { "DataEntry", "Review", "Edit", "Edit-Upload", "HTML" };
    // protected override void OnInitialized()
    {
        if (State.dataFile != null)
        {
            foreach (string item in State.dataFile.listDocSearchTypes)
            {
                docSearchTypes.Add(new DataItem()
                {
                    ID = item,
                    Text = item
                });
            }
            List<UserProfile> userProfiles = State.dataFile.GetActiveUserProfiles();
            foreach (UserProfile user in userProfiles)
            {
                listUsers.Add(new DataItem()
                    {
                        ID = user.RowKey,
                        Text = user.Name_E
                    });
            }
            foreach (string s in State.dataFile.UserTasks)
            {
                listTasks.Add(new DataItem()
                    {
                        ID = s,
                        Text = s
                    });
            }
        }
        while (State == null || State.clientTipitakaDB == null) await Task.Delay(100);
        if (State != null && State.clientTipitakaDB != null)
            clientTaskAssignmentInfo = State.clientTipitakaDB.GetClientTaskAssignmentInfo();
        await Task.Delay(300);
        taskInfoPageSize = sfgrid!.PageSettings.PageSize;
        // DisplaySpinner(true);
        // await SysAdminDocUpgrade("");
        // await SysAdminTaskReport();
        // DisplaySpinner(false);
        // await SysAdminTestLastDate();
        // await SysAdminDocStatusCheck("SN-01.02.00");
        // await SysAdminDocStatusCheck("SN-01.03.00");
        // await SysAdminCheckingMissingAuthor();
        // await SysAdminUserTaskCheck();
    }
}

@* *************************************************************************** *@
@* ***************************** Base Component ****************************** *@
@* *************************************************************************** *@
<div>
    <Administration componentName="TaskAssignment" email=@email userName=@userName userClass=@userClass flex_width="1000px">
        <adminMenuItem>Task Assignments</adminMenuItem>
    </Administration>
</div>

@* ******************************************************************************@
@* https://blazor.syncfusion.com/documentation/datagrid/template-editing        *@
@* https://blazor.syncfusion.com/documentation/treegrid/editing/template-editing*@
@* https://blazor.syncfusion.com/documentation/dialog/template                  *@
@* https://blazor.syncfusion.com/documentation/datagrid/template-editing        *@
@* ******************************************************************************@
<div>
    <div style="width:200px" class="form-group col-md-2 column">
        <label class="col-form-label">Search Type</label>
        <SfDropDownList TValue="string" TItem="DataItem" @bind-Value="searchTypeValue"
                        MultiSelectMode="None" PopupHeight="400px" DataSource="@docSearchTypes">
            <DropDownListEvents TItem="DataItem" TValue="string" ValueChange="@SearchTypeValueChangeHandler"></DropDownListEvents>
            <DropDownListFieldSettings Text="Text" Value="ID"></DropDownListFieldSettings>
        </SfDropDownList>
    </div>
    <div style="width:200px" class="form-group col-md-2 column">
        <label class="col-form-label">Search Text</label>
        <SfTextBox TValue="string" @bind-Value="@pattern" @onkeypress="@OnKeyDown" @oninput="@OnTyping"></SfTextBox>
    </div>
</div>
<br />
<div style="width:180px;height:32px; padding-top:23px; padding-left:11px" class="form-group col-md-2 column">
    <SfButton IsPrimary="true" CssClass="e-custom2" OnClick="@ShowTasks"> Show Tasks </SfButton>
</div>
<div style="width:180px;height:32px; padding-top:23px; padding-left:11px" class="form-group col-md-2 column">
    <SfButton CssClass="e-custom3" spellcheck="false" OnClick="@ShowNextTasks"> Show Next @nextCount </SfButton>
</div>
<br />
<br />
<label style="margin-left:383px;width:200px;text-align: right;"><strong>Total: </strong>@totalCount</label>
<br />
@***************************************************************************************@
@****************************** Task Assignments DataGrid ******************************@
@***************************************************************************************@
<div id="ControlRegion">
    <SfGrid ID="Grid" DataSource="@TaskInfoRecords" @ref="sfgrid" AllowPaging="true" AllowFiltering="false" AllowReordering="true" AllowResizing="true" AllowExcelExport="false" AllowSelection="true"
            AllowSorting="true" AllowTextWrap="false" Height="180" Width="1000">
            @* Toolbar="@(new List<string>() { "Add", "Edit", "Delete", "Search" })" AllowTextWrap="false" Height="380" Width="1000"> *@
        <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false" ShowDeleteConfirmDialog='false'
                          NewRowPosition="NewRowPosition.Bottom" Mode="Syncfusion.Blazor.Grids.EditMode.Normal">
        </GridEditSettings>
        <GridPageSettings PageSize="5"></GridPageSettings>
        <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Multiple"></GridSelectionSettings>
        <GridEvents TValue="TaskInfo" RowSelected="RowSelectHandler" OnActionBegin="ActionBeginTaskInfo" 
            OnActionComplete="ActionCompleteTaskInfo" OnToolbarClick="ToolbarClick" DataBound="TaskDataBound"></GridEvents>
        @* <GridEvents RowSelected="RowSelectHandler" OnActionBegin="ActionBeginTaskInfo" OnActionComplete="ActionCompleteTaskInfo" OnToolbarClick="ToolbarClick" TValue="DocInfo"></GridEvents> *@
        <GridColumns>
            <GridColumn Field=@nameof(TaskInfo.SrNo) HeaderText="Sr No" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        IsPrimaryKey="true" AllowEditing="false" Width="8%" Type="ColumnType.Integer" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.DocNo) HeaderText="Doc No" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="12%" Type="ColumnType.String" TextAlign="TextAlign.Left"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.DocTitle) HeaderText="Title" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Left" AllowEditing="false" Width="28%" Type="ColumnType.String"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.Pages) HeaderText="Pages" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="11%" Type="ColumnType.String"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.PagesSubmitted) HeaderText="Submitted" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="10%" Type="ColumnType.Integer" TextAlign="TextAlign.Center"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.Status) HeaderText="Status" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="9%" Type="ColumnType.String"></GridColumn>
            <GridColumn Field=@nameof(TaskInfo.Team) HeaderText="Team" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Left" AllowEditing="false" Type="ColumnType.String"></GridColumn>
        </GridColumns>
    </SfGrid>
</div>
@***************************************************************************************@
@************************** Task Assignment Detailed DataGrid **************************@
@***************************************************************************************@
<br />
<hr style="width:1000px" />
<div>
    <label style="font-size:21px;width:150px"><strong>Task Details</strong></Label>
    <label style="font-size:17px;width:250px"><b>@taskDetails_DocNo</b>&nbsp;&nbsp;@taskDetails_Pages</Label>
    <label style="width:600px;text-align:right;"><strong>@SourceBookLabel</strong>@sourcePDF</label>
</div>

<div id="ControlRegion">
    <div class="form-row">
        <div class="column-dialog left-dialog">
            @* <label class="col-form-label"><b>@taskDetails_DocNo</b><br />@taskDetails_Pages</label> *@
            @* <div class="control-section">
                <div class="timepicker-section">
                    <div id="wrapper" class="timepicker-control">
                        <div class="tabs-wrap">
                            <div class="wrap">
                                <label class="col-form-label">Expected Completion Date:</label>
                                <SfDatePicker TValue="DateTime?" PlaceHolder="Choose a Date" @bind-Value="@DateValue" Format="d/M/yyyy" EnableMask="true"></SfDatePicker> *@
                                @* <SfDatePicker TValue="DateTime?"></SfDatePicker> *@
                                @* <DatePickerEvents TValue="DateTime?" ValueChange="DatePickerValueChangeHandler"></DatePickerEvents> *@
                            @*</div>
                        </div>
                    </div>
                </div>
            </div> *@
            <label class="col-form-label">Select User:</label>
            <SfDropDownList TValue="string" TItem="DataItem" @ref=userDropdown MultiSelectMode="None" PopupHeight="200px"
                            Placeholder="Select user" @bind-Value="@userDropDownValue" DataSource="@listUsers">
                <DropDownListEvents TItem="DataItem" TValue="string"></DropDownListEvents>
                <DropDownListFieldSettings Text="Text" Value="ID"></DropDownListFieldSettings>
            </SfDropDownList>
        </div>
        <div class="column-dialog middle-dialog">
            <label class="col-form-label">Select Task:</label>
            <SfDropDownList TValue="string" TItem="DataItem" @ref=taskDropdown MultiSelectMode="None" PopupHeight="200px"
                            Placeholder="Select task" @bind-Value="@taskDropDownValue" DataSource="@listTasks">
                <DropDownListEvents TItem="DataItem" TValue="string"></DropDownListEvents>
                <DropDownListFieldSettings Text="Text" Value="ID"></DropDownListFieldSettings>
            </SfDropDownList>
        </div>
        <div class="column-dialog right-dialog">
        </div>
        <br />
        <div class="column-dialog right-dialog">
            <label class="col-form-label"> </label>
            <SfButton CssClass="e-custom1" Content="Add" OnClick="@AddTaskClick" />
            <SfButton CssClass="e-custom1" Content="Save" IsPrimary="true" Disabled="@isSaveDisabled" OnClick="@SaveTaskClick" />
        </div>
    </div>
</div>
<br /><br/><br/>
<div id="ControlRegion">
    <SfGrid ID="Grid" DataSource="@TaskDetailedInfoRecords" @ref="sfgrid1" AllowPaging="true" AllowFiltering="false" AllowReordering="true" AllowResizing="true" AllowExcelExport="false" AllowSelection="true"
            AllowSorting="true" AllowTextWrap="false" Height="180" Width="1000" Toolbar="@(new List<string>() { "Delete" })" OnActionBegin="GridActionBegin">
        <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="true" ShowDeleteConfirmDialog='true'
                          NewRowPosition="NewRowPosition.Bottom" Mode="Syncfusion.Blazor.Grids.EditMode.Normal">
        </GridEditSettings>
        @* <GridPageSettings PageSize="5"></GridPageSettings> *@
        <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
        <GridEvents TValue="TaskDetailedInfo" RowSelected="RowSelectHandlerTaskAssignment" OnActionBegin="ActionBeginUser" OnActionComplete="ActionCompleteUser" OnToolbarClick="ToolbarClick"></GridEvents>
        @* <GridEvents RowSelected="RowSelectHandler" OnActionBegin="ActionBeginUser" OnActionComplete="ActionCompleteTaskDetailedInfo" OnToolbarClick="ToolbarClick" TValue="DocInfo"></GridEvents> *@
        <GridSortSettings>
            <GridSortColumns>
                <GridSortColumn Field=@nameof(TaskDetailedInfo.SrNo) Direction="SortDirection.Ascending"></GridSortColumn>
            </GridSortColumns>
        </GridSortSettings>

        <GridColumns>
            <GridColumn Field=@nameof(TaskDetailedInfo.SrNo) HeaderText="Sr No" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        IsPrimaryKey="true" AllowEditing="false" Width="7%" Type="ColumnType.Integer" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.UserName) HeaderText="User Name" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="13%" Type="ColumnType.String" TextAlign="TextAlign.Left"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.Author) HeaderText="Author" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="13%" Type="ColumnType.String" TextAlign="TextAlign.Left"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.NoPages) HeaderText="Pages" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="5%" Type="ColumnType.String"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.PagesSubmitted) HeaderText="Submitted" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="8%" Type="ColumnType.Integer"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.CorrectionCount) HeaderText="Corrections" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        IsPrimaryKey="true" AllowEditing="false" Width="8%" Type="ColumnType.Integer" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.Task) HeaderText="Task" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="8%" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(TaskInfo.StartDate) HeaderText="StartDate" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="9%" Type="ColumnType.String"></GridColumn>

            <GridColumn Field=@nameof(TaskInfo.LastUpdate) HeaderText="LastUpdate" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="9%" Type="ColumnType.String"></GridColumn>

            <GridColumn Field=@nameof(TaskDetailedInfo.Status) HeaderText="Status" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="8%" Type="ColumnType.String"></GridColumn>

        </GridColumns>
    </SfGrid>
</div>
<label style="margin-left:260px;padding-top:10px;width:700px;text-align: right;"><strong>@overdueLabel</strong>@overdueDay</label>

@* <span>@checking</span> *@
<SfSpinner Type=SpinnerType.Bootstrap4 @bind-Visible="@VisibleSpinner">
</SfSpinner>

@***************************************************************************************@
@***************************** Correction Detailed DataGrid ****************************@
@***************************************************************************************@
<br />
<hr style="width:1000px" />
<label style="font-size:21px"><strong>Correction Details</strong></label>
<br/>
<label style="margin-left:287px;width:700px;text-align: right;"><strong>Total : </strong>@nCorrections</label>
<br/>

<div id="ControlRegion">
    <SfGrid ID="Grid" DataSource="@CorrectionInfoRecords" @ref="sfgrid2" AllowPaging="true" AllowFiltering="false" AllowReordering="true" AllowResizing="true" AllowExcelExport="false" AllowSelection="true"
            AllowSorting="true" AllowTextWrap="false" Height="180" Width="1000">
        <GridEditSettings AllowAdding="false" AllowEditing="false" AllowDeleting="false" ShowDeleteConfirmDialog='false'
                          NewRowPosition="NewRowPosition.Bottom" Mode="Syncfusion.Blazor.Grids.EditMode.Normal">
        </GridEditSettings>
        <GridPageSettings PageSize="5"></GridPageSettings>
        <GridSelectionSettings Type="Syncfusion.Blazor.Grids.SelectionType.Single"></GridSelectionSettings>
        <GridEvents TValue="CorrectionInfo" RowSelected="RowSelectHandlerCorrectionGrid"></GridEvents>
        @* <GridEvents RowSelected="RowSelectHandler" OnActionBegin="ActionBeginUser" OnActionComplete="ActionCompleteUser" OnToolbarClick="ToolbarClick" TValue="DocInfo"></GridEvents> *@
        <GridColumns>
            <GridColumn Field=@nameof(CorrectionInfo.SrNo) HeaderText="Sr No" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        IsPrimaryKey="true" AllowEditing="false" Width="8%" Type="ColumnType.Integer" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.AssignedTo) HeaderText="Name" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Left" AllowEditing="false" Width="18%" Type="ColumnType.String"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.Task) HeaderText="Task" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        AllowEditing="false" Width="10%" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.PageNo) HeaderText="Page" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Center" AllowEditing="false" Width="7%" Type="ColumnType.Integer"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.NISField ) HeaderText="NIS" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        IsPrimaryKey="true" AllowEditing="false" Width="7%" Type="ColumnType.String" TextAlign="TextAlign.Center"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.BeforeEdit) HeaderText="Before Edit" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Left" AllowEditing="false" Width="28%" Type="ColumnType.String"></GridColumn>

            <GridColumn Field=@nameof(CorrectionInfo.AfterEdit) HeaderText="After Edit" CustomAttributes="@(new Dictionary<string, object>(){ { "class", "e-attr1" }})"
                        TextAlign="TextAlign.Left" AllowEditing="false" Width="28%" Type="ColumnType.String"></GridColumn>
        </GridColumns>
    </SfGrid>
</div>
<br />
<label style="width:100px;"><strong>Before Edit</strong></label>
<label><strong>:&nbsp&nbsp&nbsp</strong>@beforeEdit</label>
<br/>
<label style="width:100px;"><strong>After Edit</strong></label>
<label><strong>:&nbsp&nbsp&nbsp</strong>@afterEdit</label>
<br/><br/>


@* *************************************************************************** *@
@* ************************ New doc info dialog Style ************************ *@
@* *************************************************************************** *@
<style>
    .column {
        float: left;
        padding: 9px;
        width: 250px;
        /* height: 530px; /* should be removed. only for demonstration */
    }
    .column500 {
        /* float: left; */
        padding: 9px;
        width: 50%;
        /* height: 530px; /* should be removed. only for demonstration */
    }
/*     .label_class
    {
        padding: 0px;
        width:490px;
        text-align:right;
    } */
   .container {
       display: flex; /* or display: grid; */
       flex-direction: row; /* or grid-template-columns: 1fr 1fr 1fr; */
       width: 100%; /* Adjust as needed */
   }
    .column-dialog {
        float: left;
        padding: 10px;
    }

    .left-col2-dialog {
        width: 50%;
    }

    .right-col2-dialog {
        width: 50%;
    }

    .left-dialog {
        padding: 10px;
        width: 260px;
    }

    .middle-dialog {
        padding: 10px;
        width: 260px;
    }

    .right-dialog {
        padding: 10px;
        width: 260px;
    }

    .e-custom {
        /* border-radius: 0; */
        height: 32px;
        width: 100px;
    }

    .e-custom, .e-custom:hover, .e-custom:focus, .e-custom:active {
        background-color: #ff6e40;
        color: #fff;
    }

    .e-custom1 {
        margin-top: 15px;
        margin-left: 10px;
        border-radius: 0;
        height: 30px;
        width: 90px;
    }
</style>
@********************************** Grid styles **********************************@
<style>
    .e-grid {
        line-height: 20px;
    }

    .e-headercell.e-attr1 {
        background: #cfcfcf;
    }

    .e-grid .e-altrow {
        background-color: #F3F2F1;
    }

    .e-grid .e-rowcell.e-selectionbackground {
        background-color: lightsteelblue !important;
    }

    .e-grid tr.e-row:hover .e-rowcell:not(.e-cellselectionbackground):not(.e-active):not(.e-updatedtd):not(.e-indentcell) {
        border-block-color: black;
        border-block-start-color: black;
        /* border-bottom-color: black; */
    }
</style>
@******************************* SfButton styles ********************************@
<style>
    .e-custom2 {
        /* border-radius: 25px; */
        height: 32px;
        width: 140px;
    }

    .e-custom3 {
        display: @showNextButton;
        /* border-radius: 25px; */
        height: 32px;
        width: 140px;
        background-color: white;
    }
</style>
@* ***************************** End of Grid styles ************************** *@
@* *************************************************************************** *@
@* ************************ New doc info dialog Code ************************* *@
@* *************************************************************************** *@
@code {
    /************************************************************************************/
    //******** Classes and variables
    /************************************************************************************/
    public class TaskInfo()
    {
        public int SrNo { get; set; }
        public string DocNo { get; set; } = "";
        public string DocTitle { get; set; } = "";
        public string Task { get; set; } = "";
        public string Pages { get; set; } = "";
        public int PagesSubmitted { get; set; }
        public DateTime? DateForSorting { get; set; }
        public string StartDate { get; set; } = "";
        public string LastUpdate { get; set; } = "";
        public int CorrectionCount { get; set; }
        public string Status { get; set; } = "";
        public string Team { get; set; } = "";
    };
    public class TaskDetailedInfo()
    {
        public int SrNo { get; set; }
        public string DocNo { get; set; } = "";
        public string UserName { get; set; } = "";
        public string Author { get; set; } = "";
        public string UserID { get; set; } = "";
        public string AuthorID { get; set; } = "";
        public string NoPages { get; set; } = "";
        public int? PagesSubmitted { get; set; }
        public string Task { get; set; } = "";
        public string StartDate { get; set; } = "";
        public DateTime? StartDateForSorting { get; set; }
        public string LastUpdate { get; set; } = "";
        public int? CorrectionCount { get; set; }
        public string Status { get; set; } = "";
    };
    public class CorrectionInfo()
    {
        public int SrNo { get; set; }
        public string DocNo { get; set; } = "";
        public string AssignedTo { get; set; } = "";
        public string Task { get; set; } = "";
        public int PageNo { get; set; }
        public string NISField { get; set; } = "";
        public string BeforeEdit { get; set; } = "";
        public string AfterEdit { get; set; } = "";
        public string Date { get; set; } = "";
    }
    public DateTime? DateValue { get; set; }
    private List<DataItem> docSearchTypes = new List<DataItem>();
    List<TaskInfo> TaskInfoRecords = new List<TaskInfo>();
    List<TaskInfo> listSelectedTaskInfo = new List<TaskInfo>();
    List<TaskDetailedInfo> TaskDetailedInfoRecords = new List<TaskDetailedInfo>();
    List<CorrectionInfo> CorrectionInfoRecords = new List<CorrectionInfo>();
    ClientTaskAssignmentInfo? clientTaskAssignmentInfo = null;
    TaskInfo? selectedTaskInfo = null;
    SfGrid<TaskInfo>? sfgrid;
    SfGrid<TaskDetailedInfo>? sfgrid1;
    SfGrid<CorrectionInfo>? sfgrid2;
    SfDatePicker<DateTime?>? sfdatepicker;
    SfDropDownList<string, DataItem>? userDropdown;
    SfDropDownList<string, DataItem>? taskDropdown;
    bool VisibleSpinner = false;

    /************************************************************************************/
    //******** Variables
    /************************************************************************************/
    string searchTypeValue = "", searchType = "", pattern = "";
    string userDropDownValue = "", taskDropDownValue = "";
    string showNextButton = "none";

    List<string>? docTypes, docSubTypes;
    List<DataItem> listDocs = new List<DataItem>();
    List<DataItem> listPDFItems = new List<DataItem>();
    List<DataItem> listUsers = new List<DataItem>();
    List<DataItem> listTasks = new List<DataItem>();
    List<SuttaInfo> newSuttaList = new List<SuttaInfo>();
    List<int>? SelectedRowIndexes { get; set; }
    List<string> listDeleteTaskDetailedInfo = new List<string>();
    TaskDetailedInfo? selectedTaskDetailedInfo = null;
    int taskInfoCurrentPage { get; set; } = 0;
    int taskInfoPageSize { get; set; } = 0;

    Dictionary<string, int> dictPDFPageCount = new Dictionary<string, int>();
    public SfDropDownList<string, DataItem>? docDropdown;
    public SfDropDownList<string, DataItem>? srcPDFDropdown;
    public SfComboBox<string, DataItem>? docSubTypeCombo;

    bool isSaveDisabled = true;
    string ErrMsgNewDocInfo = "";
    string formattedDocNo = "";
    string taskDetails_DocNo = "", taskDetails_Pages = "";
    string doc_No = "", doc_Title = "", doc_SubTitle = "", pages_Count = "";
    string sourcePDF = "", SourceBookLabel = "";
    string beforeEdit = "", afterEdit = "";
    string loadedDocType = "";
    string overdueLabel = "";
    string overdueDay = "";
    int selectedBookPages = 0;
    int? startPage = 0, endPage = 0;
    int idxTaskAssignmentRowSelect = -1;
    int idxTaskRowSelect = -1;
    int totalCount = 0, nextCount = 0;
    int nCorrections = 0;
    bool IsVisible_NewDocInfo = false;


    //************************************************************************************/
    //******** OnKeyDown & OnTyping
    /************************************************************************************/
    private void OnTyping(Microsoft.AspNetCore.Components.ChangeEventArgs args)
    {
        if (args != null && args.Value != null)
        {
            this.pattern = args.Value.ToString();
        }
    }
    public async Task OnKeyDown(KeyboardEventArgs args)
    {
        if (args.Code == "Enter" && pattern.Length != 0 && searchType.Length != 0)
        {
            await ShowTasks();
        }
    }
    private void InputHandler_NewDocInfo(InputEventArgs args)
    {
        ErrMsgNewDocInfo = String.Empty;
    }
    public async Task AlertBtn(string msg, string warn)
    {
        await DialogService.AlertAsync(msg, warn, new DialogOptions()
            {
                PrimaryButtonOptions = new DialogButtonOptions() { Content = "Ok" }
            });
    }
    //************************************************************************************/
    //******** Search value change events
    /************************************************************************************/
    private void SearchTypeValueChangeHandler(ChangeEventArgs<string, DataItem> args)
    {
        if (args != null && args.ItemData != null)
            searchType = args.ItemData.Text;
        else searchType = String.Empty;
    }
    /************************************************************************************/
    //******** ShowTasks
    /************************************************************************************/
    private async Task ShowTasks()
    {
        TaskDetailedInfoRecords = new List<TaskDetailedInfo>();
        VisibleSpinner = true; 
        await Task.Delay(50);
        await ShowTasksServer();
        VisibleSpinner = false;
    }
    private async Task ShowTasksServer()
    {
        selectedTaskInfo = null;
        if (searchTypeValue == null || searchTypeValue.Length == 0)
        {
            await AlertBtn("Please select search type first.", "Warning");
            return;
        }
        // VisibleSpinner = true; await Task.Delay(500);
        // retrieve
        List<SuttaInfo> listSuttaInfo = await State.dataFile.GetSuttaListAsync(searchTypeValue, pattern, userClass);
        totalCount = State.dataFile.GetSearchResultCount();
        TaskInfoRecords = new List<TaskInfo>();
        if (totalCount == 0)
            await AlertBtn("No tasks found.", "Alert");

        List<TaskInfo> listTaskInfo = new List<TaskInfo>();
        foreach (SuttaInfo suttaInfo in listSuttaInfo)
        {
            listTaskInfo.Add(new TaskInfo()
                {
                    SrNo = listTaskInfo.Count + 1,
                    DocNo = suttaInfo.RowKey,
                    DocTitle = suttaInfo.Title,
                    Pages = String.Format("{0}-{1} ({2})", suttaInfo.StartPage, suttaInfo.EndPage, suttaInfo.EndPage - suttaInfo.StartPage + 1),
                //Pages = suttaInfo.EndPage - suttaInfo.StartPage + 1,
                    DateForSorting = GetLastUpdated(suttaInfo.RowKey),
                    PagesSubmitted = suttaInfo.PagesSubmitted,
                    Status = suttaInfo.Status,
                    Team = suttaInfo.Team
                });
        }
        // the following code not needed anymore as the return listTaskInfo is 
        // already in sorted order
        // listTaskInfo = listTaskInfo.OrderByDescending(o => o.DateForSorting).ToList();
        // redo serial nos
        int n = 0;
        foreach(TaskInfo taskInfo in listTaskInfo)
        {
            taskInfo.SrNo = ++n;
        }
        idxTaskRowSelect = -1;
        idxTaskAssignmentRowSelect = -1;
        TaskInfoRecords = listTaskInfo;

        //TaskDetailedInfoRecords = new List<TaskDetailedInfo>();
        if (TaskInfoRecords.Count < totalCount)
        {
            int remainingCount = totalCount - TaskDetailedInfoRecords.Count;
            if (remainingCount >= 10) nextCount = 10;
            else nextCount = remainingCount;
            showNextButton = "block";
        }
        else showNextButton = "none";
        // VisibleSpinner = false; await Task.Delay(50);
    }
    private DateTime? GetLastUpdated(string docNo)
    {
        if (clientTaskAssignmentInfo == null) return null;
        TaskAssignmentInfo? taskAssignmentInfo = clientTaskAssignmentInfo.GetTaskAssignmentInfo(docNo);
        DateTime dateTime = DateTime.Now;
        if (taskAssignmentInfo != null && taskAssignmentInfo.Timestamp != null)
        {
            int y = taskAssignmentInfo.Timestamp.Value.Year;
            int m = taskAssignmentInfo.Timestamp.Value.Month;
            int d = taskAssignmentInfo.Timestamp.Value.Day;
            dateTime = new DateTime(y, m, d);
        }
        return dateTime;
    }
    private void ShowNextTasks()
    {
        List<SuttaInfo> listSuttaInfo = State.dataFile!.GetNextBatchSearchedSuttas();
        List<TaskInfo> listTaskInfo = TaskInfoRecords.ToList();

        foreach (SuttaInfo suttaInfo in listSuttaInfo)
        {
            listTaskInfo.Add(new TaskInfo()
                {
                    SrNo = listTaskInfo.Count + 1,
                    DocNo = suttaInfo.RowKey,
                    DocTitle = suttaInfo.Title,
                    Pages = String.Format("{0}-{1} ({2})", suttaInfo.StartPage, suttaInfo.EndPage, suttaInfo.EndPage - suttaInfo.StartPage + 1),
                    PagesSubmitted = suttaInfo.PagesSubmitted,
                    Status = suttaInfo.Status,
                    Team = suttaInfo.Team
                });
        }
        TaskInfoRecords = listTaskInfo;
        if (TaskInfoRecords.Count < totalCount)
        {
            int remainingCount = totalCount - TaskInfoRecords.Count;
            if (remainingCount >= 10) nextCount = 10;
            else nextCount = remainingCount;
            showNextButton = "block";
        }
        else showNextButton = "none";
    }
    private async Task TaskDataBound()
    {
        if (selectedTaskInfo != null)
        {
            var listTask = (from item in TaskInfoRecords 
                            where item.DocNo == selectedTaskInfo.DocNo 
                            select item).ToList();
            if (listTask.Count == 0) return;
            var totalPages = (int)((TaskInfoRecords.Count - 1) / 5) + 1;
            var curPage = (int)((listTask[0].SrNo - 1) / 5) + 1;
            int rowIdx = (listTask[0].SrNo % 5);
            rowIdx = (rowIdx == 0) ? 4 : rowIdx - 1; 
            await sfgrid!.GoToPageAsync(curPage);
            await sfgrid.SelectRowAsync(rowIdx);
            selectedTaskInfo = null;
        }
    }

    private void onCancelNewDoc()
    {
        ErrMsgNewDocInfo = String.Empty;
        IsVisible_NewDocInfo = false;
    }
    private void docValueChangeHandler(ChangeEventArgs<string, DataItem> args)
    {
        ErrMsgNewDocInfo = String.Empty;
        string[] f = args.ItemData.ID.Split(' ');
        doc_No = f[1];
        int idx = Int32.Parse(f[0].Substring(0, f[0].Length - 1));
        f = args.ItemData.Text.Split('/');
        int p1 = f[0].IndexOf('(');
        int p2 = f[0].IndexOf(')');
        string t = f[0].Substring(p1+1, p2-p1-1);
        // string[] ff = t.Split('/');
        // doc_Title = ff[0];
        doc_Title = t;
        // doc_SubTitle = (ff.Length == 2) ? ff[1] : "";
        if (idx > 0 && idx < newSuttaList.Count)
        {
            --idx;
            var s = newSuttaList[idx];
            pages_Count = String.Format("{0}-{1} ({2})", s.StartPage, s.EndPage, s.NoPages);
            SourceBookInfo? sourceBookInfo = State.dataFile.GetSourceBookInfo(s.BookID);
            if (sourceBookInfo != null) sourcePDF = sourceBookInfo.BookFilename;
        }
    }
    private void docSubTypeValueChangeHandler(ChangeEventArgs<string, DataItem> args)
    {
        ErrMsgNewDocInfo = String.Empty;
        // if (args.ItemData != null) doc_SubType = args.ItemData.Text; else doc_SubType = "";
        formatDocNo();
    }
    private void docNoValueChangedHandler(InputEventArgs args)
    {
        ErrMsgNewDocInfo = String.Empty;
        doc_No = args.Value;
        formatDocNo();
    }
    private void PDFValueChangeHandler(ChangeEventArgs<string, DataItem> args)
    {
        ErrMsgNewDocInfo = String.Empty;
        // selectedPDF = args.ItemData.Text;
        // if (selectedPDF.Length > 0) selectedBookPages = dictPDFPageCount[selectedPDF];
    } 
    private void formatDocNo()
    {
        formattedDocNo = "";
        // if (doc_Type.Length > 0) formattedDocNo = doc_Type;
        // if (doc_SubType.Length > 0) formattedDocNo += "." + doc_SubType;
        // if (doc_No.Length > 0) formattedDocNo += "-" + doc_No;
    }
    private Dictionary<string, string> GetUserTaskProgressData(string s)
    {
        Dictionary<string, string> dict = new Dictionary<string, string>();
        if (s.Length > 0) 
        {
            string[] f = s.Split(";");
            foreach(string item in f)
            {
                string[] ff = item.Split("=");
                dict[ff[0]] = ff[1];
            }
        }
        return dict;
    }
    //********************************
    //******** AddTaskClick()
    //********************************
    private void AddTaskClick()
    {
        if (TaskDetailedInfoRecords.Count == 0)
        {
            AlertBtn("The table is empty. A document needs to be added or selected.", "Error"); return;
        }
        // if (DateValue == null)
        // {
        //     AlertBtn("Expected completion date not selected.", "Error"); return;
        // }
        if (userDropDownValue == null || userDropDownValue.Length == 0)
        {
            AlertBtn("User not selected.", "Error"); return;
        }
        if (taskDropDownValue == null || taskDropDownValue.Length == 0)
        {
            AlertBtn("Task not selected.", "Error"); return;
        }
        // no errors at this point
        List<TaskDetailedInfo> listTaskDetailedInfo = TaskDetailedInfoRecords.ToList();
        // DateTime dt = (DateTime)DateValue;
        // listTaskDetailedInfo[0].LastUpdate = String.Format("{0}/{1}/{2}", dt.Day, dt.Month, dt.Year);
        //
        // check for Upload task. It should be the only task in the list.
        //
        // if (taskDropDownValue == "Edit-Upload")
        // {
        //     if (listTaskDetailedInfo.Count > 1 || 
        //         (listTaskDetailedInfo.Count == 1 && listTaskDetailedInfo[0].Task != "NewDoc"))
        //     {
        //         AlertBtn("Edit-Upload must be the task after NewDoc.", "Error"); return;
        //     }
        // }
        //
        // check for multiple DataEntry tasks.
        //
        if (taskDropDownValue == "DataEntry")
        {
            var list = (from item in listTaskDetailedInfo
                        where item.Task == "DataEntry"
                        select item).ToList();
            if (list.Count > 0)
            {
                AlertBtn("Only one DataEntry task allowed.", "Error"); return;
            }
            if (listTaskDetailedInfo.Count > 1)
            {
                AlertBtn("DataEntry task must be the first task assigned.", "Error"); return;
            }
            isSaveDisabled = false;
        }
        // 
        // Check if user has been already assigned, Check for DataEntry tasks only
        //
        // if (taskDropDownValue != "Edit-Upload" && taskDropDownValue != "HTML")
        // {
        //     var listItems = (from item in TaskDetailedInfoRecords
        //                      where item.UserID == userDropDownValue
        //                      select item).ToList();
        //     if (listItems.Count > 0)
        //     {
        //         AlertBtn(String.Format("\"{0}\" is already been assigned.", listItems[0].UserName), "Error"); return;
        //     }
        // }
        // check for Review
        string task = taskDropDownValue;
        if (task.Contains("Review"))
        {
            if (listTaskDetailedInfo.Count < 2 || listTaskDetailedInfo[0].Task != "NewDoc" || listTaskDetailedInfo[1].Task != "DataEntry")
            {
                isSaveDisabled = true;
                AlertBtn("Review task cannot be assigned without DataEntry task.", "Error");
                return;
            }
            TaskDetailedInfo lastTask = listTaskDetailedInfo.Last();
            if (lastTask.Task == "Review4" && lastTask.Status != "Completed")
            {
                isSaveDisabled = true;
                AlertBtn("No tasks allowed after incompleted Review4.", "Error");
                return;
            }
            isSaveDisabled = false;
        }
        if (idxTaskAssignmentRowSelect <= 0)
        {
            listTaskDetailedInfo.Add(new TaskDetailedInfo()
                {
                    SrNo = listTaskDetailedInfo.Count + 1,
                    DocNo = listTaskDetailedInfo[0].DocNo,
                    UserID = userDropDownValue,
                    UserName = State.dataFile.GetUserName(userDropDownValue),
                    Author = userName,
                    AuthorID = email,
                    NoPages = listTaskDetailedInfo[0].NoPages,
                    PagesSubmitted = 0,
                    Task = task,
                    StartDate = "",
                    LastUpdate = "",
                    CorrectionCount = 0,
                    Status = ""
                });
        }
        else
        {
            listTaskDetailedInfo.Insert(idxTaskAssignmentRowSelect, new TaskDetailedInfo()
                {
                    SrNo = idxTaskAssignmentRowSelect + 1,
                    DocNo = listTaskDetailedInfo[0].DocNo,
                    UserID = userDropDownValue,
                    UserName = State.dataFile.GetUserName(userDropDownValue),
                    Author = userName,
                    AuthorID = email,
                    NoPages = listTaskDetailedInfo[0].NoPages,
                    PagesSubmitted = 0,
                    Task = task,
                    StartDate = "",
                    LastUpdate = "",
                    CorrectionCount = 0,
                    Status = ""
                });
            for(int i = idxTaskAssignmentRowSelect + 1; i < listTaskDetailedInfo.Count; i++)
            {
                ++listTaskDetailedInfo[i].SrNo;
            }
            idxTaskAssignmentRowSelect = -1;
        }
        TaskDetailedInfoRecords = listTaskDetailedInfo;
    }
    //************************************************************************************************
    //******** SaveTaskClick()
    //*** https://www.newtonsoft.com/json/help/html/DeserializeObject.htm*/
    //************************************************************************************************
    private async Task SaveTaskClick()
    {
        //string docNo = "";
        if (TaskDetailedInfoRecords.Count == 0)
        {
            AlertBtn("No tasks to save.", "Error");
            return;
        }
        if (SelectedRowIndexes == null || SelectedRowIndexes.Count == 0) return;
        VisibleSpinner = true;
        // if there are rows deleted, process them first
        if (listDeleteTaskDetailedInfo.Count > 0 && State != null && State.dataFile != null)
        {
            // remove user from task
            foreach (string item in listDeleteTaskDetailedInfo)
            {
                string[] f = item.Split("|");
                if (f.Length == 3)
                {
                    await State.dataFile.RemoveUserFromDocTeamAsync(f[0], f[1]);
                    await State.dataFile.RemoveUserDocFromKeyValue(f[0], f[1], f[2]);
                }
            }
            listDeleteTaskDetailedInfo.Clear();
        }
        foreach(TaskInfo taskInfo in listSelectedTaskInfo)
        {
            var result = await SaveTaskAsync(taskInfo.DocNo);
            if (!result) break;
        }
        isSaveDisabled = true;
        //await ShowTasks();
        VisibleSpinner = false;
    }
    private async Task<bool> SaveTaskAsync(string docNo)
    {
        List<UserTaskProgressInfo> dictUserTaskProgressInfo = new List<UserTaskProgressInfo>();
        // save task assignment info
        string userTaskAssignments = "";
        //string docNo = TaskDetailedInfoRecords[0].DocNo;
        //DateValue = null;
        // if (DateValue == null)
        // {
        //     AlertBtn("Please select the estimated completion date before contuning.", "Error");
        //     return false;
        // }
        int totalSubmittedPages = 0;
        DateTime dt = DateTime.Now; //(DateTime)DateValue;
        string currentDate = DateTime.Now.ToString("dd/MM/yyy");
        TaskDetailedInfoRecords[0].LastUpdate = currentDate;
        List<string> teamMembers = new List<string>();
        List<string> logTeamMembers = new List<string>();
        string key, assignedUserName;
        foreach (var item in TaskDetailedInfoRecords)
        {
            assignedUserName = State.dataFile!.GetUserName(item.UserID);
            // continue only if the userID is valid
            if (assignedUserName.Length == 0) continue; // skip if the userID is not valid
            if (item.Status.Length == 0) item.Status = TaskCategories._Assigned_; 
            if (item.PagesSubmitted == null) item.PagesSubmitted = 0;
            if (item.StartDate != null && item.StartDate.Length == 0)
                item.StartDate = currentDate;
            userTaskAssignments = State.dataFile.UserTaskAssignment(userTaskAssignments, item.UserID, item.Task,
                                  item.StartDate, item.LastUpdate, (int)item.PagesSubmitted, item.Status);
            // prepare for NewtonSoft Json lib
            key = item.Task == "NewDoc" ? "Created" : item.Task;
            dictUserTaskProgressInfo.Add(new UserTaskProgressInfo()
                {
                    userID = item.UserID,
                    author = item.AuthorID,          // admin name
                    task = item.Task,
                    startDate = item.StartDate,
                    lastDate = item.LastUpdate,
                    submitted = (int)item.PagesSubmitted,
                    corrections = 0,
                    status = item.Status
                });
            totalSubmittedPages += (int)item.PagesSubmitted;
            if (assignedUserName.Length > 0) 
            {
                teamMembers.Add(assignedUserName);
                logTeamMembers.Add(String.Format("{0}:{1}", assignedUserName, item.Task));
            }
        }
        int pages = totalSubmittedPages; 
        // SerializeObject to string using NewtonSoft Json
        userTaskAssignments = JsonConvert.SerializeObject(dictUserTaskProgressInfo);
        string lastStatus = State.dataFile.GetDocStatus(dictUserTaskProgressInfo); // GetLastStatus(userTaskAssignments);
        if (lastStatus.Length == 0) lastStatus = TaskCategories._Assigned_;
        TaskAssignmentInfo taskAssignmentInfo = new TaskAssignmentInfo()
            {
                RowKey = docNo,
                PagesSubmitted = 0,
                AssigneeProgress = userTaskAssignments,
                StartDate = TaskDetailedInfoRecords[0].StartDate,
                LastDate = TaskDetailedInfoRecords[0].LastUpdate,
                CorrectionCount = 0,
                Status = lastStatus,
            };
        // update screens
        string team = String.Join(", ", teamMembers);
        string logTeam = String.Join("|", logTeamMembers);
        if (idxTaskRowSelect >= 0)
        {
            var newlist = TaskInfoRecords.ToList();
            newlist[idxTaskRowSelect].Status = lastStatus;
            newlist[idxTaskRowSelect].Team = team;
            // newlist[idxTaskRowSelect].Task = team;
            TaskInfoRecords = newlist;
            sfgrid.SelectRowAsync(idxTaskRowSelect);
        }
        if (State.dataFile != null)
        {
            taskAssignmentInfo.Status = lastStatus;

            // user and doc will be updated to KeyValueData
            await State.dataFile.UpdateTaskAssignmentInfoAsync(taskAssignmentInfo, docNo);
            // Update suttaInfo
            await State.dataFile.UpdateSuttaInfoAsync(docNo, lastStatus, team);
            await State.dataFile.AddActivityLogAsync(email, "Task", String.Format("{0} task assigned.", docNo));
            int percentage = (int)(((float)totalSubmittedPages / (float)pages) * 100);

            string[] pgNos = State.dataFile.ParsePageInfo(TaskDetailedInfoRecords[0].NoPages);
            await State.dataFile.AddTaskActivityLogAsync(docNo, email, "Assignment", 
                    (pgNos.Length == 3) ? Int32.Parse(pgNos[2]) : 0, 
                    0, 0, GetTaskLog(taskAssignmentInfo.AssigneeProgress));

            // var userList = dictUserTaskProgressInfo.Select(r=>r.userID).ToList();
            // userList.RemoveAt(0);
            // ClientKeyValueData? clientKeyValueData = State.dataFile.GetClientKeyValueData();
            // if (clientKeyValueData != null) 
            // {
            //     await clientKeyValueData.AddUserTasksAsync(userList.ToArray(), docNo);
            //     // clientKeyValueData.AddUserDocByCategory("admin", TaskCategories._Recent_, docNo);
            //     // clientKeyValueData.AddUserDocByCategory(userList.ToArray(), TaskCategories._Assigned_, docNo);
            // }
            string GetTaskLog(string assigneeProgress)
            {
                string s = "";
                if (assigneeProgress.Length == 0) return s;
                var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
                if (listUserTaskProgressInfo != null)
                {
                    foreach(UserTaskProgressInfo item in listUserTaskProgressInfo)
                    {
                        if (s.Length > 0) s += "!";
                        s += String.Format("{0}|{1}|{2}|{3}|{4}|{5}", item.userID, item.author, item.task, item.startDate, item.submitted, item.status);
                    }
                }
                return s;
            }
        }
        return true;
    }
    private string GetLastStatus(string userTaskAssignments)
    {
        string lastStatus = "";
        if (userTaskAssignments.Length == 0) return lastStatus;
        var listUserTaskInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(userTaskAssignments);
        if (listUserTaskInfo != null && listUserTaskInfo.Count > 0)
        {
            if (listUserTaskInfo[listUserTaskInfo.Count - 1].status == "Completed" &&
            listUserTaskInfo[listUserTaskInfo.Count - 1].task == "Review4") lastStatus = "Done";
            else lastStatus = listUserTaskInfo[listUserTaskInfo.Count - 1].status;
        }
        return lastStatus;
    }
    /************************************************************************************/
    //******** Grid events
    /************************************************************************************/
    public async Task ToolbarClick(Syncfusion.Blazor.Navigations.ClickEventArgs args)
    {
        if (args != null)
        {
            if (args.Item.Text.Equals("Add") && State.dataFile !=  null)
            {
                IsVisible_NewDocInfo = true;
                if (newSuttaList.Count == 0)
                {
                    newSuttaList = State.dataFile.GetSuttaList("100");
                    int n = 0;
                    foreach(SuttaInfo suttaInfo in newSuttaList)
                    {
                        //string s = String.Format("{0} ({1})", suttaInfo.RowKey, suttaInfo.Title)
                        listDocs.Add(new DataItem()
                        {
                            ID = String.Format("{0}. {1}", ++n, suttaInfo.RowKey),
                            Text = String.Format("{0} ({1})", suttaInfo.RowKey, suttaInfo.Title)
                        });
                    }
                }
                args.Cancel = true;
            }
            if (args.Item.Text.Equals("Edit"))
            {
                IsVisible_NewDocInfo = true;
                args.Cancel = true;
            }
            if (args.Item.Text.Equals("Delete"))
            {
                // TaskDetailedInfoRecords
                IsVisible_NewDocInfo = false;
                if (selectedTaskDetailedInfo != null)
                {
                    if (selectedTaskDetailedInfo.Task == "NewDoc")
                    {
                        await AlertBtn("You cannot remove the document owner.", "Alert");
                        args.Cancel = true;
                    }
                    if (selectedTaskDetailedInfo.PagesSubmitted > 0)
                    {
                        await AlertBtn("This user has already started submitted data and cannot be removed.", "Alert");
                        args.Cancel = true;
                    }
                }
            }
        }
    }
    //****************************************************************
    //******** RowSelectHandler()
    //****************************************************************
    public async Task RowSelectHandler(RowSelectEventArgs<TaskInfo> args)
    {
        if (State.dataFile == null || sfgrid == null) return;
        SelectedRowIndexes = await this.sfgrid.GetSelectedRowIndexesAsync();
        listSelectedTaskInfo = await this.sfgrid.GetSelectedRecordsAsync();
        TaskInfo taskInfo = args.Data;
        selectedTaskInfo = args.Data;
        idxTaskRowSelect = args.RowIndex;
        taskDetails_DocNo = selectedTaskInfo.DocNo;
        taskDetails_Pages = selectedTaskInfo.Pages;

        DisplaySpinner(true);
        if (taskInfo == null) return;
        //TaskInfo taskInfo = listTaskInfo[taskInfo.SrNo];
        TaskAssignmentInfo? taskAssignmentInfo = State.dataFile.GetTaskAssignmentInfo(taskInfo.DocNo);
        if (taskAssignmentInfo == null) return;
        if (taskAssignmentInfo.LastDate.Length > 0)
        {
            string[] dd = taskAssignmentInfo.LastDate.Split('/');
            DateValue = new DateTime(Int32.Parse(dd[2]), Int32.Parse(dd[1]), Int32.Parse(dd[0]));
        }
        //**********************************************************/
        //*** GetDocTaskActivities()
        //**********************************************************/
        ClientTaskActivityLog clientTaskActivityLog = State.dataFile.GetClientTaskActivityLog();
        List<TaskActivityLog> taskActivityLog = new List<TaskActivityLog>();
        if (clientTaskActivityLog != null)
        {
            var result = await clientTaskActivityLog.GetDocTaskActivities(taskInfo.DocNo);
            taskActivityLog = ((List<TaskActivityLog>)result).Where(s => s.Activity == "Assignment").OrderBy(s => s.Timestamp).ToList();
        }
        //**********************************************************/
        //**** Parse Assignee Progress using Json Method ***********/
        var listUserTaskInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(taskAssignmentInfo.AssigneeProgress);
        //**********************************************************/
        // string taskLastStatus = State.dataFile.GetLastStatus(listUserTaskInfo!);
        // if (taskLastStatus != taskInfo.Status)
        // {
        //     // need to update the doc latest status
        //     TaskInfoRecords[args.RowIndex].Status = taskLastStatus;
        //     await sfgrid.Refresh();
        //     State.dataFile.UpdateSuttaInfo(taskInfo.DocNo, taskLastStatus, taskInfo.Team);
        // }
        List<TaskDetailedInfo> taskDetailedInfo = new List<TaskDetailedInfo>();
        int reviewNo = 0; string status = "";
        int correctionCount = 0;
        overdueLabel = "";
        overdueDay = "";
        int stDay, stMon, stYear;
        string userName = "";
        DateTime? stDateTime = null;
        string pattern = @"\((.*?)\)";
        string extractedPages;
        Regex regex = new Regex(pattern);
        Match match = regex.Match(taskInfo.Pages);
        if (match.Success) extractedPages = match.Groups[1].Value;
        else extractedPages = taskInfo.Pages;

        if (listUserTaskInfo != null && listUserTaskInfo.Count > 0)
        {
            foreach (UserTaskProgressInfo t in listUserTaskInfo)
            {
                status = State.dataFile.GetTaskStatus(taskAssignmentInfo, t);
                // if (status == "Review")
                // {
                //     status = String.Format("Review{0}", ++reviewNo);
                // }
                string[] sdt = t.startDate.Split('/');
                if (sdt.Length == 3)
                {
                    stDay = int.Parse(sdt[0]);
                    stMon = int.Parse(sdt[1]);
                    stYear = int.Parse(sdt[2]);
                    stDateTime = new DateTime(stYear, stMon, stDay);
                }
                else
                {
                    // tasks that have not been started yet are set a max date so that they
                    // are listed at the end
                    stDateTime = new DateTime();
                    stDateTime = DateTime.MaxValue;
                }
                // Match match = regex.Match(taskInfo.Pages);
                // if (match.Success) extractedPages = match.Groups[1].Value;
                // else extractedPages = taskInfo.Pages;
                userName = State.dataFile.GetUserName(t.userID);
                taskDetailedInfo.Add(new TaskDetailedInfo()
                    {
                        SrNo = taskDetailedInfo.Count + 1,
                        DocNo = taskInfo.DocNo,
                        UserID = t.userID,
                        UserName = userName,
                        Author = State.dataFile.GetUserName(t.author),
                        AuthorID = t.author,
                        NoPages = extractedPages, //taskInfo.Pages,
                        Task = t.task,
                        StartDate = t.startDate, //DateTime.Now.ToString("d/M/yyyy"),
                        StartDateForSorting = stDateTime,
                        LastUpdate = t.lastDate,
                        PagesSubmitted = t.submitted,
                        CorrectionCount = t.corrections,
                        Status = status
                    });
                correctionCount += t.corrections;
            }
        }
        taskDetailedInfo = taskDetailedInfo.OrderBy(o => o.StartDateForSorting).ToList();
        SourceBookLabel = "Source Book : ";
        sourcePDF = State.dataFile.GetSourceBook(taskInfo.DocNo);
        // doc creator is always at index 0
        taskDetailedInfo[0].LastUpdate = taskAssignmentInfo.LastDate;
        taskDetailedInfo[0].PagesSubmitted = null;
        taskDetailedInfo[0].CorrectionCount = null;
        TaskDetailedInfoRecords = taskDetailedInfo;
        //CalculateDaysFromDueDate();

        ClientCorrectionLog? clientCorrectionLog = State.dataFile.GetClientCorrectionLog();
        List<CorrectionInfo> corrections = new List<CorrectionInfo>();
        List<CorrectionLog> correctionLog = new List<CorrectionLog>();
        CorrectionInfoRecords.Clear();
        if (clientCorrectionLog != null)
        {
            correctionLog = clientCorrectionLog.QueryCorrections(taskInfo.DocNo);
            if (correctionLog != null)
            {
                int srno = 0;
                foreach(CorrectionLog item in correctionLog)
                {
                    corrections.Add(new CorrectionInfo()
                    {
                        SrNo = ++srno,
                        DocNo = taskInfo.DocNo,
                        AssignedTo = State.dataFile.GetUserName(item.UserID),
                        Task = item.Task,
                        PageNo = item.PageNo,
                        NISField = item.NISRec,
                        BeforeEdit = item.OrigText,
                        AfterEdit = item.EditedText,
                        //Date = item.Timestamp.ToString("d'/'M'/'yyyy")
                    });
                }
                CorrectionInfoRecords = corrections;
                nCorrections = corrections.Count;
            }
        }
        DisplaySpinner(false);
        beforeEdit = "";
        afterEdit = "";
    }
    void CalculateDaysFromDueDate()
    {
        if (TaskDetailedInfoRecords.Count == 0 || TaskDetailedInfoRecords[0].LastUpdate.Length == 0) return;
        DateTime? dt1 = null, dt2 = null;
        int days = 0;
        string[] f1 = TaskDetailedInfoRecords[0].LastUpdate.Split("/");
        if (f1.Length == 3)
        {
            dt1 = new DateTime(Int32.Parse(f1[2]), Int32.Parse(f1[1]), Int32.Parse(f1[0]), 0, 0, 0);
        }
        TaskDetailedInfo lastTaskDetailedInfo = TaskDetailedInfoRecords[TaskDetailedInfoRecords.Count - 1];
        if (lastTaskDetailedInfo.Status == "Completed")
        {
            string[] f2 = lastTaskDetailedInfo.LastUpdate.Split("/");
            dt2 = new DateTime(Int32.Parse(f2[2]), Int32.Parse(f2[1]), Int32.Parse(f2[0]), 0, 0, 0);
        }
        else
        {
            dt2 = new DateTime(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
        }

        if (dt1 != null && dt2 != null)
        {
            if (dt2 < dt1) //dt2 = ((DateTime)dt2).AddDays(-1);
            {
                days = (int)((DateTime)dt1 - (DateTime)dt2).TotalDays;
                overdueLabel = "Days to due date : ";
                overdueDay = String.Format("{0}", days);
            }
            else
            {
                days = (int)((DateTime)dt2 - (DateTime)dt1).TotalDays;
                overdueLabel = "Days past due date : ";
                overdueDay = String.Format("{0}{1}", (days > 0) ? "+" : "", days);
            }
        }
        return;
    }
    public void DatePickerValueChangeHandler(ChangedEventArgs<DateTime?> args)
    {
        // Here, you can customize your code.
        DateTime? dt = null; //args.Value;
    }
    //****************************************************************
    //******** RowSelectHandlerTaskAssignment()
    //****************************************************************
    public void RowSelectHandlerTaskAssignment(RowSelectEventArgs<TaskDetailedInfo> args)
    {
        if (State.dataFile == null) return;
        selectedTaskDetailedInfo = args.Data;
        idxTaskAssignmentRowSelect = args.RowIndex;
        // userDropDownValue = args.Data.UserID;
        // taskDropDownValue = args.Data.Task;
    }
    private async Task ActionBeginUser(ActionEventArgs<TaskDetailedInfo> args)
    {
        if ((args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete) && args.Action == "Delete"))
        {
            var r = args.Row;
            var rd = args.RowData;
            var data = args.Data;
            if (args.Data.Task == "NewDoc")
            {
                args.Cancel = true;
                await AlertBtn("You cannot remove the document owner.", "Alert");
                return;
            }
            if (args.Data.PagesSubmitted > 0)
            {
                args.Cancel = true;
                await AlertBtn("This user has already started submitted data and cannot be removed.", "Alert");
                return;
            }
            if (selectedTaskDetailedInfo != null && selectedTaskDetailedInfo.Status == "Assigned")
            {
                string s = String.Format("{0}|{1}|{2}", selectedTaskDetailedInfo.DocNo, selectedTaskDetailedInfo.UserID, selectedTaskDetailedInfo.Task);
                listDeleteTaskDetailedInfo.Add(s);
            }
        }
    }
    private void ActionCompleteUser(ActionEventArgs<TaskDetailedInfo> args)
    {
        if ((args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete) && args.Action == "Delete"))
        {
            TaskDetailedInfo taskDetailedInfo = args.Data;
            // enable/disable Save button
            if (TaskDetailedInfoRecords.Count == 1) isSaveDisabled = TaskDetailedInfoRecords[0].Task != "NewDoc";
            else
            {
                isSaveDisabled = TaskDetailedInfoRecords[0].Task != "NewDoc" || TaskDetailedInfoRecords[1].Task != "DataEntry";
            }
        }
    }
    private void ActionBeginTaskInfo(ActionEventArgs<TaskInfo> args)
    {
        if (args.Action == "delete")// && args..Key == "delete")
        {
            // Prevent the default delete action
            args.Cancel = true;
            // Add your custom handler here
            //  ShowDeleteConfirmation(e.RowData);
            // Optionally, perform your custom action
        }
    }
    private void ActionCompleteTaskInfo(ActionEventArgs<TaskInfo> args)
    {
        // if ((args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Delete) && args.Action == "Delete"))
        // {
        //     if (selectedTaskDetailedInfo != null && selectedTaskDetailedInfo.Status == "Assigned")
        //     {
        //         string s = String.Format("{0}|{1}", selectedTaskDetailedInfo.DocNo, selectedTaskDetailedInfo.UserID);
        //         // listDeleteTaskDetailedInfo.Add(s);
        //     }
        // }
        if (args.RequestType.Equals(Syncfusion.Blazor.Grids.Action.Paging))
        {
            taskInfoCurrentPage = sfgrid.PageSettings.CurrentPage;
        }
    }
    public void GridActionBegin(ActionEventArgs<TaskDetailedInfo> e)//GridActionBeginEventArgs e)
    {
        // if (e.Action == "delete" && e.Key == "delete")
        // {
        //     // Prevent the default delete action
        //     e.Cancel = true;
        //     // Add your custom handler here
        //     // ShowDeleteConfirmation(e.RowData);
        //     // Optionally, perform your custom action
        // }
    }
    public void RowSelectHandlerCorrectionGrid(RowSelectEventArgs<CorrectionInfo> args)
    {
        CorrectionInfo correctionInfo = args.Data;
        beforeEdit = correctionInfo.BeforeEdit;
        afterEdit = correctionInfo.AfterEdit;
    }
    private async Task SysAdminTestLastDate()
    {
        string docNo = "DN-01.02";
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        TaskAssignmentInfo taskAssignmentInfo = await clientTaskAssignmentInfo.GetTaskAssignmentInfoAsync(docNo);
        //**********************************************************/
        //**** Parse Assignee Progress using Json Method ***********/
        var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(taskAssignmentInfo.AssigneeProgress);
        //**********************************************************/
        string dt = GetLastUpdate(listUserTaskProgressInfo);
        Debug.WriteLine("LastDate = " + dt);
    }
    private async Task SysAdminDocStatusCheck(string docNo)
    {
        if (State == null || State.dataFile == null) return;
        string newStatus;
        ClientSuttaInfo? clientSuttaInfo = State.dataFile!.GetClientSuttaInfo();
        String query = "RowKey ge 'SN-' and RowKey lt 'SN~'";
        List<SuttaInfo> listSuttaInfo = await clientSuttaInfo.QuerySuttaInfoAsync(query);
        Debug.WriteLine("DocNo,Status");
        foreach (SuttaInfo suttaInfo in listSuttaInfo)
        {
            var taskAssignmentInfo = await clientTaskAssignmentInfo.GetTaskAssignmentInfoAsync(suttaInfo.RowKey);
            string assigneeProgress = taskAssignmentInfo.AssigneeProgress.Replace("Edit-Upload", "DataEntry");
            //**********************************************************/
            //**** Parse Assignee Progress using Json Method ***********/
            var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
            //**********************************************************/
            newStatus = State.dataFile.GetDocStatus(listUserTaskProgressInfo);
            Debug.WriteLine(String.Format("{0},{1}", suttaInfo.RowKey, newStatus));
        }
    }
    private async Task  SysAdminTaskReport()
    {
        // This is routine is only for the SysAdmin. No one else is allowed to use this function.
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        ClientSuttaInfo? clientSuttaInfo = State.dataFile!.GetClientSuttaInfo();
        ClientSuttaPageData? clientSuttaPageData = State.dataFile!.GetClientSuttaPageData();
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        ClientTaskActivityLog? clientTaskActivityLog = State.dataFile!.GetClientTaskActivityLog();
        List<SuttaInfo> listSuttaInfo = State.dataFile.GetSuttaList("Assigned", "", userClass);
        String query = "RowKey ge 'DN' and RowKey lt 'DN~'";
        // query = "RowKey eq 'DN.Tika-03.04.00'";
        // var dictSuttaInfo = State.dataFile.GetAllSuttaList(query);
        listSuttaInfo = await clientSuttaInfo.QuerySuttaInfoAsync(query);
        int n = listSuttaInfo.Count;
        Debug.WriteLine("Total found = " + n.ToString());
        string docNo = "", assigneeProgress = "", NewDoc = "", R0 = "", R1 = "", R2 = "", R3 = "", R4 = "", Others = "";
        string taskSequenceCheck = "", initials = "";
        string newStatus = "", assigneeStatuses = "";
        int nPages = 0, submittedPages = 0;
        int pageDataCount = 0;
        TaskAssignmentInfo? taskAssignmentInfo = null;
        List<TaskActivityLog> listTaskActivityLog;
        bool devReport = false;
        n = 0;
        if (clientSuttaInfo == null || clientSuttaPageData == null || 
            clientTaskAssignmentInfo == null || clientTaskActivityLog == null) return;
        if (devReport) Debug.WriteLine("DocNo\tNoPages\tSubmittedPages\tDataPageCount\tNewDoc\tDataEntry\tReview1\tReview2\tReview3\tReview4\tOthers\tStatus\tAssigneeStatus");
        else Debug.WriteLine("DocNo\tNoPages\tSubmittedPages\tDataPageCount\tNewDoc\tDataEntry\tReview1\tReview2\tReview3\tReview4\tOthers\tStatus\tTask Sequence Check");
        foreach (SuttaInfo suttaInfo in listSuttaInfo)
        {
            nPages = suttaInfo.NoPages;
            submittedPages = suttaInfo.PagesSubmitted;
            pageDataCount = await clientSuttaPageData.GetDocPageDataCount(suttaInfo.RowKey);
            taskAssignmentInfo = await clientTaskAssignmentInfo.GetTaskAssignmentInfoAsync(suttaInfo.RowKey);
            assigneeProgress = taskAssignmentInfo.AssigneeProgress;
            if (!devReport) assigneeProgress = assigneeProgress.Replace("Edit-Upload", "DataEntry");
            //**********************************************************/
            //**** Parse Assignee Progress using Json Method ***********/
            var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
            //**********************************************************/
            NewDoc = R0 = R1 = R2 = R3 = R4 = Others = assigneeStatuses = "";
            taskSequenceCheck = initials = "";
            newStatus = State.dataFile.GetDocStatus(listUserTaskProgressInfo);
            foreach(UserTaskProgressInfo userTaskProgressInfo in listUserTaskProgressInfo)
            {
                listTaskActivityLog = await clientTaskActivityLog.GetDocTaskActivities(suttaInfo.RowKey);
                listTaskActivityLog = listTaskActivityLog.OrderBy(c => c.Timestamp).ToList();
                //userTaskProgressInfo.task = userTaskProgressInfo.task.Replace("Edit-Upload", "DataEntry");
                switch(userTaskProgressInfo.task)
                {
                    case "NewDoc": 
                        NewDoc = State.dataFile.GetUserName(userTaskProgressInfo.userID);
                        NewDoc += "/" + GetInitials(userTaskProgressInfo.userID);
                        break;
                    case "DataEntry": 
                        R0 = State.dataFile.GetUserName(userTaskProgressInfo.userID);
                        if (userTaskProgressInfo.author.Length > 0) initials = GetInitials(userTaskProgressInfo.author);
                        else initials = GetAuthor(userTaskProgressInfo.userID, listTaskActivityLog);
                        R0 += "/" + initials;
                        if (devReport)
                            assigneeStatuses += String.Format("|{0}:{1}:{2}", userTaskProgressInfo.userID, userTaskProgressInfo.task, userTaskProgressInfo.status);
                        break;
                    case "Review1": 
                        R1 = State.dataFile.GetUserName(userTaskProgressInfo.userID); 
                        R1 += "/" + GetAuthor(userTaskProgressInfo.userID, listTaskActivityLog);
                        if (devReport)
                            assigneeStatuses += String.Format("|{0}:{1}:{2}", userTaskProgressInfo.userID, userTaskProgressInfo.task, userTaskProgressInfo.status);
                        break;
                    case "Review2": 
                        R2 = State.dataFile.GetUserName(userTaskProgressInfo.userID); 
                        R2 += "/" + GetAuthor(userTaskProgressInfo.userID, listTaskActivityLog);
                        if (devReport)
                            assigneeStatuses += String.Format("|{0}:{1}:{2}", userTaskProgressInfo.userID, userTaskProgressInfo.task, userTaskProgressInfo.status);
                        break;
                    case "Review3": 
                        R3 = State.dataFile.GetUserName(userTaskProgressInfo.userID); 
                        R3 += "/" + GetAuthor(userTaskProgressInfo.userID, listTaskActivityLog);
                        if (devReport)
                            assigneeStatuses += String.Format("|{0}:{1}:{2}", userTaskProgressInfo.userID, userTaskProgressInfo.task, userTaskProgressInfo.status);
                        break;
                    case "Review4": 
                        R4 = State.dataFile.GetUserName(userTaskProgressInfo.userID); 
                        R4 += "/" + GetAuthor(userTaskProgressInfo.userID, listTaskActivityLog);
                        if (devReport)
                            assigneeStatuses += String.Format("|{0}:{1}:{2}", userTaskProgressInfo.userID, userTaskProgressInfo.task, userTaskProgressInfo.status);
                        break;
                    default:
                        if (Others.Length > 0) Others += "|";
                        Others += userTaskProgressInfo.task + ": " + State.dataFile.GetUserName(userTaskProgressInfo.userID);
                        break;
                }
            }
            if (taskAssignmentInfo != null)
            {
                if (pageDataCount != suttaInfo.PagesSubmitted) taskSequenceCheck = "Error: Submitted data count does not match with actual server page data. ";
                taskSequenceCheck += TaskSequenceCheck(listUserTaskProgressInfo);
                if (devReport)
                {
                    if (assigneeStatuses.Length > 0) assigneeStatuses = assigneeStatuses.Substring(1);
                    Debug.WriteLine(String.Format("{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}\t{12}", suttaInfo.RowKey, 
                            nPages, submittedPages, pageDataCount, NewDoc, R0, R1, R2, R3, R4, Others, newStatus, assigneeStatuses));
                }
                else
                    Debug.WriteLine(String.Format("{0}\t{1}\t{2}\t{3}\t{4}\t{5}\t{6}\t{7}\t{8}\t{9}\t{10}\t{11}\t{12}", suttaInfo.RowKey, 
                        nPages, submittedPages, pageDataCount, NewDoc, R0, R1, R2, R3, R4, Others, newStatus, taskSequenceCheck));
                ++n;
                //if (n >= 1) return;
            }
            else return;
        }
        Debug.WriteLine("Done.");
        if (nPages >= 0) return;
        string GetInitials(string userID)
        {
            switch(userID)
            {
                case "heinsithuwin95@gmail.com": return "HSTW";
                case "aungthulin@gmail.com": return "ATL";
                case "nwayyananthlaing@gmail.com": return "NYH";
                case "dhammayaungchi2011@gmail.com": return "DY";
                default: return "UNK";
            }
        }
        string GetAuthor(string userID, List<TaskActivityLog> listTaskActivityLog)
        {
            string uname = State.dataFile.GetUserName(userID);
            foreach(TaskActivityLog taskActivityLog in listTaskActivityLog)
            {
                if (taskActivityLog.Activity == "Assignment" && taskActivityLog.Description.Contains(uname))
                {
                    return GetInitials(taskActivityLog.UserID);
                }
            }
            return "";
        }
        string TaskSequenceCheck(List<UserTaskProgressInfo> listUserTaskProgressInfo)
        {
            string seq = "";
            bool completed = false;
            string errMsg = "";
            if (listUserTaskProgressInfo.Count > 0 && listUserTaskProgressInfo[0].task != "NewDoc")
            {
                errMsg = "NewDoc missing";
                return "NewDoc missing.";
            }
            seq = "New";
            if (listUserTaskProgressInfo.Count > 1 && listUserTaskProgressInfo[1].task != "DataEntry" && 
                listUserTaskProgressInfo[1].task != "Edit-Upload")
            {
                errMsg = "DataEntry missing.";
                seq += "-?";
                return "DataEntry missing. Seq=" + seq;
            }
            seq += "-DataEntry";
            if (listUserTaskProgressInfo.Count > 2 && listUserTaskProgressInfo[2].task == "Review4") 
            {
                seq += "-Review4";
                return "Review1-3 missing. Seq=" + seq;
            }
            if (listUserTaskProgressInfo.Count >= 3)
            {
                for(int i = 2; i < listUserTaskProgressInfo.Count(); i++)
                {
                    if (listUserTaskProgressInfo[i].task.Contains("Review"))
                    {
                        seq += "-" + listUserTaskProgressInfo[i].task;
                    }
                }
                if (listUserTaskProgressInfo.Last().task != "Review4")
                {
                    return "Ok (incomplete). Seq=" + seq;
                }
                completed = true;
            }
            if (completed) return "Ok (completed). Seq=" + seq;
            return "Ok (incomplete). Seq=" + seq;
        }
    }
    private string GetAuthorID(string userID, List<TaskActivityLog> listTaskActivityLog)
    {
        string uname = State.dataFile.GetUserName(userID);
        foreach(TaskActivityLog taskActivityLog in listTaskActivityLog)
        {
            if (taskActivityLog.Activity == "Assignment" && taskActivityLog.Description.Contains(uname))
            {
                return taskActivityLog.UserID;
            }
        }
        return "";
    }
    private string GetLastUpdate(List<UserTaskProgressInfo> listUserTaskProgressInfo)
    {
        DateTime maxdt = DateTime.MinValue;
        DateTime dt;
        foreach(UserTaskProgressInfo userTaskProgressInfo in listUserTaskProgressInfo)
        {
            dt = MakeDateTime(userTaskProgressInfo.lastDate);
            if (dt > maxdt) maxdt = dt;
        }
        return String.Format("{0}/{1}/{2}", maxdt.Day, maxdt.Month, maxdt.Year);
        DateTime MakeDateTime(string dt)
        {
            string[] f = dt.Split("/");
            if (f.Length == 3)
            {
                int yr = int.Parse(f[2]);
                int mm = int.Parse(f[1]);
                int dd = int.Parse(f[0]);
                DateTime dateTime = new DateTime(int.Parse(f[2]), int.Parse(f[1]), int.Parse(f[0]));
                return dateTime;
            }
            return DateTime.MinValue;
        }
    }
    private async Task SysAdminDocUpgrade(string docNo = "")
    {
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        ClientSuttaInfo? clientSuttaInfo = State.dataFile!.GetClientSuttaInfo();
        ClientSuttaPageData? clientSuttaPageData = State.dataFile!.GetClientSuttaPageData();
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        ClientTaskActivityLog? clientTaskActivityLog = State.dataFile!.GetClientTaskActivityLog();
        ClientKeyValueData? clientKeyValueData = State.dataFile!.GetClientKeyValueData();
        if (clientSuttaInfo == null || clientSuttaPageData == null || clientTaskAssignmentInfo == null ||
            clientTaskActivityLog == null || clientSuttaInfo == null) return;

        string query = "";
        if (docNo.Length == 0) query = "RowKey ge 'DN' and RowKey lt 'DN~' and Status ne 'Created'";
        else query = String.Format("RowKey eq '{0}'", docNo);
        List<SuttaInfo> listSuttaInfo = await clientSuttaInfo.QuerySuttaInfoAsync(query);
        int n = 0, count = 0, pageDataCount = 0;
        Debug.WriteLine(String.Format("Found count = {0}", listSuttaInfo.Count));
        foreach(SuttaInfo suttaInfo in listSuttaInfo)
        {
            //if (++n > 1) break;
            string logMsg = "";
            docNo = suttaInfo.RowKey;
            // get TaskAssignmentInfo
            TaskAssignmentInfo? taskAssignmentInfo = await clientTaskAssignmentInfo.GetTaskAssignmentInfoAsync(docNo);
            if (taskAssignmentInfo != null)
            {
                string assigneeProgress = taskAssignmentInfo.AssigneeProgress.Replace("Edit-Upload", "DataEntry");
                if (assigneeProgress != taskAssignmentInfo.AssigneeProgress) logMsg += " Edit-Upload -> DataEntry";
                //**********************************************************/
                //**** Parse Assignee Progress using Json Method ***********/
                var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
                //**********************************************************/
                string docStatus = State.dataFile.GetDocStatus(listUserTaskProgressInfo);
                //SuttaInfo suttaInfo = await clientSuttaInfo.GetSuttaInfoAsync(docNo);
                if (suttaInfo != null)
                {
                    List<TaskActivityLog> listTaskActivityLog = await clientTaskActivityLog.GetDocTaskActivities(suttaInfo.RowKey);
                    listTaskActivityLog = listTaskActivityLog.OrderBy(c => c.Timestamp).ToList();
                    List<UserTaskProgressInfo> listUserTaskProgressInfo2 = new List<UserTaskProgressInfo>();
                    pageDataCount = await clientSuttaPageData.GetDocPageDataCount(suttaInfo.RowKey);
                    string authorId;
                    // if doc creator is missing, add back in
                    if (!assigneeProgress.Contains("NewDoc"))
                    {
                        var t = listTaskActivityLog.FirstOrDefault(r => r.Activity == "Created");  
                        if (t != null)
                        {
                            DateTimeOffset t1 = (DateTimeOffset)(t.Timestamp);
                            string sdate = String.Format("{0}/{1}/{2}", t1.Day, t1.Month, t1.Year);
                            listUserTaskProgressInfo2.Add(new UserTaskProgressInfo()
                            {
                                userID = t.UserID,
                                author = t.UserID,
                                task = "NewDoc",
                                startDate = sdate,
                                lastDate = GetLastUpdate(listUserTaskProgressInfo),
                                submitted = 0,
                                corrections = 0,
                                status = "Created",
                            });
                            logMsg += " Doc creator added.";
                        }
                    }
                    foreach(UserTaskProgressInfo userTaskProgressInfo in listUserTaskProgressInfo)
                    {
                        if (userTaskProgressInfo.task == "NewDoc")
                        {
                            userTaskProgressInfo.lastDate = GetLastUpdate(listUserTaskProgressInfo);
                            authorId = userTaskProgressInfo.userID;
                            logMsg += " NewDoc LastDate updated.";
                        }
                        else authorId = GetAuthorID(userTaskProgressInfo.userID, listTaskActivityLog);
                        listUserTaskProgressInfo2.Add(new UserTaskProgressInfo()
                        {
                            userID = userTaskProgressInfo.userID,
                            author = authorId,
                            task = userTaskProgressInfo.task,
                            startDate = userTaskProgressInfo.startDate,
                            lastDate = userTaskProgressInfo.lastDate,
                            submitted = userTaskProgressInfo.submitted,
                            corrections = userTaskProgressInfo.corrections,
                            status = userTaskProgressInfo.status,
                        });
                    }
                    taskAssignmentInfo.Status = docStatus;
                    taskAssignmentInfo.AssigneeProgress = JsonConvert.SerializeObject(listUserTaskProgressInfo2);
                    await clientTaskAssignmentInfo.UpdateTaskAssignmentInfoAsync(taskAssignmentInfo);
                    logMsg += " Author added.";
                    if (suttaInfo.Status != docStatus) logMsg += " Status corrected.";
                    suttaInfo.Status = docStatus;
                    await clientSuttaInfo.UpdateSuttaInfoAsync(suttaInfo);
                    await clientKeyValueData.UpdateUserTaskAssignmentAsync(docNo, taskAssignmentInfo);
                    logMsg += " Users task statuses added.";
                    if (pageDataCount != suttaInfo.PagesSubmitted) logMsg += " Error: Submitted page count doesn't match actual data count.";
                    // update Task log
                    await clientTaskActivityLog.AddTaskActivityLogAsync(docNo,
                            email, "Corrected", count, count, count, logMsg);
                }
            }
            Debug.WriteLine(suttaInfo.RowKey + " upgraded.");
        }
        Debug.WriteLine("Done.");
    }
    private async Task SysAdminUserTaskCheck()
    {
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        string query = "RowKey ge 'DN.' and RowKey lt 'DN~'";
        // string userID = "poeeisan96.pes@gmail.com";
        // string taskStatus = "Completed";
        string assigneeProgress = "";
        int count = 0;
        List<TaskAssignmentInfo> listTaskAssignmentInfo = await clientTaskAssignmentInfo.QueryTaskAssignmentInfoAsync(query);
        Debug.WriteLine(String.Format("Total found = {0}", listTaskAssignmentInfo.Count));
        foreach(TaskAssignmentInfo taskAssignmentInfo in listTaskAssignmentInfo)
        {
            if (true)
            {
                assigneeProgress = taskAssignmentInfo.AssigneeProgress;
                //**********************************************************/
                //**** Parse Assignee Progress using Json Method ***********/
                var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
                //**********************************************************/
                // var t = listUserTaskProgressInfo.FirstOrDefault(x => x.userID == userID);// && x.status == taskStatus);
                // var t = listUserTaskProgressInfo.FirstOrDefault(x => x.status == "Uploaded");// && x.status == taskStatus);
                if (listUserTaskProgressInfo[0].author == "")
                {
                    var t0 = listUserTaskProgressInfo[0];
                    Debug.WriteLine(String.Format("DocNo {0} userID = {1} author = {2}", taskAssignmentInfo.RowKey,
                         t0.userID, t0.author));
                    ++count;
                    listUserTaskProgressInfo[0].author = listUserTaskProgressInfo[0].userID;
                    taskAssignmentInfo.AssigneeProgress = JsonConvert.SerializeObject(listUserTaskProgressInfo);
                    Debug.WriteLine(String.Format("DocNo {0} progressInfo = {1}", taskAssignmentInfo.RowKey, taskAssignmentInfo.AssigneeProgress));
                    clientTaskAssignmentInfo.UpdateTableRec(taskAssignmentInfo);
                }
            }
        }
        Debug.WriteLine(String.Format("Done. Total = {0}", count));
    }
    private async Task SysAdminCheckingMissingAuthor()
    {
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        // ClientSuttaInfo? clientSuttaInfo = State.dataFile!.GetClientSuttaInfo();
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        string query = "RowKey ge 'DN' and RowKey lt 'DN~' and Status eq 'Assigned'";
        string assigneeProgress;
        List<TaskAssignmentInfo> listTaskAssignmentInfo = await clientTaskAssignmentInfo.QueryTaskAssignmentInfoAsync(query);
        Debug.WriteLine("Total found = " + listTaskAssignmentInfo.Count.ToString());
        int n = 0;
        foreach (TaskAssignmentInfo taskAssignmentInfo in listTaskAssignmentInfo)
        {
            //if (++n > 1) break;
            // get TaskAssignmentInfo
            assigneeProgress = taskAssignmentInfo.AssigneeProgress;
            if (assigneeProgress.Contains("\"author\":\"\","))
            {
                //**********************************************************/
                //**** Parse Assignee Progress using Json Method ***********/
                var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
                //**********************************************************/
                var t = listUserTaskProgressInfo.FirstOrDefault(x => x.task == "NewDoc");
                if (t != null)
                {
                    ++n;
                    Debug.WriteLine(String.Format("{0}. {1} {2}", n, taskAssignmentInfo.RowKey, t.userID));
                    string repl = String.Format("\"author\":\"{0}\",", t.userID);
                    taskAssignmentInfo.AssigneeProgress = assigneeProgress.Replace("\"author\":\"\",", repl);
                    await clientTaskAssignmentInfo.UpdateTaskAssignmentInfoAsync(taskAssignmentInfo);
                }
            }
        }
        Debug.WriteLine("Done.");
    }
    private async Task SysAdminCheckingMissingAuthor2()
    {
        if (State.dataFile == null && email != "dhammayaungchi2011@gamil.com") return;
        ClientSuttaInfo? clientSuttaInfo = State.dataFile!.GetClientSuttaInfo();
        ClientTaskAssignmentInfo? clientTaskAssignmentInfo = State.dataFile!.GetClientTaskAssignmentInfo();
        string query = "RowKey ge 'SN-' and RowKey lt 'SN~'";
        // query = "RowKey eq 'SN-24.03.19'";
        List<SuttaInfo> listSuttaInfo = await clientSuttaInfo.QuerySuttaInfoAsync(query);
        string docNo;
        foreach (SuttaInfo suttaInfo in listSuttaInfo)
        {
            //if (++n > 1) break;
            string logMsg = "";
            docNo = suttaInfo.RowKey;
            // get TaskAssignmentInfo
            TaskAssignmentInfo? taskAssignmentInfo = await clientTaskAssignmentInfo.GetTaskAssignmentInfoAsync(docNo);
            if (taskAssignmentInfo != null)
            {
                string assigneeProgress = taskAssignmentInfo.AssigneeProgress;
                //**********************************************************/
                //**** Parse Assignee Progress using Json Method ***********/
                var listUserTaskProgressInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(assigneeProgress);
                //**********************************************************/
                string creatorID = email;
                var t = listUserTaskProgressInfo.FirstOrDefault(r => r.task == "NewDoc");  
                if (t != null)
                {
                    creatorID = t.userID;
                }
                int i = 0;
                int fixAdmin = -1;
                bool authorFix = false;
                List<UserTaskProgressInfo> listUserTaskProgressInfo1 = new List<UserTaskProgressInfo>(listUserTaskProgressInfo);
                foreach(var userTaskProgressInfo in listUserTaskProgressInfo1)
                {
                    if (userTaskProgressInfo.task == "NewDoc" && userTaskProgressInfo.userID == "dhammayaungchi2011@gmail.com")
                    {
                        fixAdmin = i;
                    }
                    if (userTaskProgressInfo.author.Length == 0)
                    {
                        Debug.WriteLine(String.Format("{0} {1} {2} missing author. Creator = {3}", docNo,
                            userTaskProgressInfo.userID, userTaskProgressInfo.task, creatorID));
                        listUserTaskProgressInfo[i].author = creatorID;
                        authorFix = true;
                    }
                    ++i;
                }
                if (fixAdmin != -1 || authorFix)
                {
                    if (fixAdmin != -1)
                    {
                        listUserTaskProgressInfo[fixAdmin].userID = "nwayyananthlaing@gmail.com";
                        listUserTaskProgressInfo[fixAdmin].author = "nwayyananthlaing@gmail.com";
                        Debug.WriteLine("Admin fixed = nwayyananthlaing@gmail.com");                        
                    }
                    taskAssignmentInfo.AssigneeProgress = JsonConvert.SerializeObject(listUserTaskProgressInfo);
                    await clientTaskAssignmentInfo.UpdateTaskAssignmentInfoAsync(taskAssignmentInfo);
                }
            }
        }
        Debug.WriteLine("Done");
    }
    private async Task AdminCheckingTaskStatuses()
    {
        ClientTipitakaDB_w clientTipitakaDB_W = State.clientTipitakaDB;
        ClientSuttaPageData clientSuttaPageData = clientTipitakaDB_W.GetClientSuttaPageData();
        ClientTaskAssignmentInfo clientTaskAssignmentInfo = clientTipitakaDB_W.GetClientTaskAssignmentInfo();
        ClientSuttaInfo clientSuttaInfo = clientTipitakaDB_W.GetClientSuttaInfo();
        string DocNo;
        // List<SuttaPageData> listSuttaPageData;
        SuttaInfo suttaInfo;
        TaskAssignmentInfo taskAssignmentInfo;

        for(int i = 1; i <= 152; i++)
        {
            DocNo = String.Format("MN-{0}", i.ToString("d3"));
            suttaInfo = clientSuttaInfo.GetSuttaInfo(DocNo);
            var listSuttaPageData = clientSuttaPageData.GetSuttaPageData(DocNo);
            if (listSuttaPageData != null)
            {

            }
            taskAssignmentInfo = clientTaskAssignmentInfo.GetTaskAssignmentInfo(DocNo);
        }
    }
    private async Task AdminCheckingTaskStatuses1()
    {
        if (State == null || email != "dhammayaungchi2011@gmail.com") return;
        ClientTipitakaDB_w clientTipitakaDB_W = State.clientTipitakaDB;
        ClientKeyValueData clientKeyValueData = clientTipitakaDB_W.GetClientKeyValueData();
        string user = "hayzinhtut234@gmail.com";// "lwinmarmar55@gmail.com";
        Debug.WriteLine("\nTask Status Check for " + user);
        Debug.WriteLine("--------------------------------------------------");
        List<string> taskAssigned = clientKeyValueData.GetUserDocs(user, "Assigned");
        List<string> taskCompleted = clientKeyValueData.GetUserDocs(user, "Data Completed");
        List<string> tasks = new List<string>(taskAssigned);

        foreach(string assigned in taskAssigned)
        {
            if (taskCompleted.Contains(assigned))
            {
                Debug.WriteLine(String.Format("Assigned task {0} found in Completed.", assigned));
                tasks.Remove(assigned);
            }
        }
        Debug.WriteLine(String.Format("Remaining no. of tasks left = {0}", tasks.Count));
        Debug.WriteLine("--------------------------------------------------");
        // check the remaining tasks if they are really completed
        TaskAssignmentInfo? taskAssignmentInfo;
        string progress;
        foreach(string docNo in tasks)
        {
            taskAssignmentInfo = clientTaskAssignmentInfo.GetTaskAssignmentInfo(docNo);
            if (taskAssignmentInfo != null)
            {
                progress = taskAssignmentInfo.AssigneeProgress;
                //**********************************************************/
                //**** Parse Assignee Progress using Json Method ***********/
                var listUserTaskInfo = JsonConvert.DeserializeObject<List<UserTaskProgressInfo>>(taskAssignmentInfo.AssigneeProgress);
                //**********************************************************/
                string taskLastStatus = State.dataFile.GetLastStatus(listUserTaskInfo!);
                foreach(UserTaskProgressInfo taskProgressInfo in listUserTaskInfo)
                {
                    progress = String.Format("DocNo = {0} User = {1} Task = {2} Status = {3}", docNo,
                                taskProgressInfo.userID, taskProgressInfo.task, taskProgressInfo.status);
                    Debug.WriteLine(progress);
                    // clientKeyValueData.RemoveUserDocByCategory(email, TaskCategories._Assigned_, DocID);
                    // clientKeyValueData.AddUserDocByCategory(email, TaskCategories._Recent_, DocID);
                    // clientKeyValueData.AddUserDocByCategory(email, TaskCategories._Completed_, DocID);    
                }
                Debug.WriteLine("");
            }

        }
        await clientKeyValueData.UpdateUserTaskStatus("auz@gmail.com", "MN-044", "Assigned");

        return;
    }
}